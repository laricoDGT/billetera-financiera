---
import { auth } from "../lib/auth";
import { query } from "../lib/db";

const session = await auth.api.getSession({
  headers: Astro.request.headers,
});

let transactions = [];

if (session) {
  const result = await query(
    `SELECT t.*, a.name as account_name 
         FROM financial_transactions t
         LEFT JOIN financial_accounts a ON t.account_id = a.id
         WHERE t.user_id = $1 
         ORDER BY t.date DESC`,
    [session.user.id]
  );
  transactions = result.rows;
}

// Helper to group transactions by date
const groupTransactionsByDate = (transactions: any[]) => {
  const groups: Record<string, any[]> = {};

  transactions.forEach((transaction) => {
    const date = new Date(transaction.date);
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);

    let key = date.toLocaleDateString("es-ES", {
      weekday: "long",
      year: "numeric",
      month: "long",
      day: "numeric",
    });

    // Check for Today and Yesterday
    if (date.toDateString() === today.toDateString()) {
      key = "HOY";
    } else if (date.toDateString() === yesterday.toDateString()) {
      key = "AYER";
    } else {
      // Capitalize first letter
      key = key.charAt(0).toUpperCase() + key.slice(1);
    }

    if (!groups[key]) {
      groups[key] = [];
    }
    groups[key].push(transaction);
  });

  return groups;
};

const groupedTransactions = groupTransactionsByDate(transactions);

// Helper to format currency
const formatCurrency = (amount: number | string) => {
  return new Intl.NumberFormat("en-US", {
    style: "currency",
    currency: "USD",
  }).format(Number(amount));
};

// Helper to format time
const formatTime = (dateString: string) => {
  const date = new Date(dateString);
  return new Intl.DateTimeFormat("es-ES", {
    hour: "2-digit",
    minute: "2-digit",
  }).format(date);
};
---

<div
  id="transactions-page"
  class="hidden min-h-screen bg-gray-50 dark:bg-slate-900"
>
  <nav class="bg-white dark:bg-slate-800 shadow-sm sticky top-0 z-30">
    <div class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <div class="flex items-center space-x-4">
          <button
            onclick="showPage('dashboard-page')"
            class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
          </button>
          <h1 class="text-xl font-bold text-gray-900 dark:text-white">
            Transacciones
          </h1>
        </div>
        <button
          onclick="showModal('add-transaction')"
          class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition flex items-center space-x-2"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 4v16m8-8H4"></path>
          </svg>
          <span>Nueva</span>
        </button>
      </div>
    </div>
  </nav>

  <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
    <!-- Filters -->
    <div
      class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm p-6 border border-gray-200 dark:border-slate-700 mb-6"
    >
      <div class="grid md:grid-cols-4 gap-4">
        <div>
          <label
            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >Buscar</label
          >
          <input
            type="text"
            placeholder="Buscar transacci贸n..."
            class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500"
          />
        </div>
        <div>
          <label
            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >Categor铆a</label
          >
          <select
            class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500"
          >
            <option>Todas</option>
            <option>Alimentaci贸n</option>
            <option>Transporte</option>
            <option>Entretenimiento</option>
          </select>
        </div>
        <div>
          <label
            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >Tipo</label
          >
          <select
            class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500"
          >
            <option>Todos</option>
            <option>Ingresos</option>
            <option>Gastos</option>
          </select>
        </div>
        <div>
          <label
            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
            >Per铆odo</label
          >
          <select
            class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500"
          >
            <option>Este mes</option>
            <option>Mes pasado</option>
            <option>ltimos 3 meses</option>
            <option>Este a帽o</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Transactions List -->
    <div class="space-y-4">
      {
        transactions.length === 0 ? (
          <div class="text-center py-12 text-gray-500 dark:text-gray-400 bg-white dark:bg-slate-800 rounded-2xl shadow-sm">
            No hay transacciones registradas.
          </div>
        ) : (
          Object.entries(groupedTransactions).map(
            ([dateGroup, groupTransactions]) => (
              <div>
                <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400 mb-3 uppercase">
                  {dateGroup}
                </h3>
                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-gray-200 dark:border-slate-700 divide-y divide-gray-200 dark:divide-slate-700">
                  {groupTransactions.map((transaction) => (
                    <div class="flex items-center justify-between p-4 hover:bg-gray-50 dark:hover:bg-slate-700 transition">
                      <div class="flex items-center space-x-4">
                        <div
                          class={`w-12 h-12 rounded-xl flex items-center justify-center text-2xl ${
                            transaction.type === "Ingreso"
                              ? "bg-green-100 dark:bg-green-900/20 text-green-600"
                              : "bg-red-100 dark:bg-red-900/20 text-red-600"
                          }`}
                        >
                          {transaction.category === "Alimentaci贸n" && ""}
                          {transaction.category === "Transporte" && ""}
                          {transaction.category === "Entretenimiento" && ""}
                          {transaction.category === "Hogar" && ""}
                          {transaction.category === "Salud" && ""}
                          {transaction.category === "Educaci贸n" && ""}
                          {transaction.category === "Salario" && ""}
                          {![
                            "Alimentaci贸n",
                            "Transporte",
                            "Entretenimiento",
                            "Hogar",
                            "Salud",
                            "Educaci贸n",
                            "Salario",
                          ].includes(transaction.category) && ""}
                        </div>
                        <div>
                          <div class="font-bold text-gray-900 dark:text-white">
                            {transaction.description || transaction.category}
                          </div>
                          <div class="text-sm text-gray-500 dark:text-gray-400">
                            {formatTime(transaction.date)} {" "}
                            {transaction.category}
                          </div>
                        </div>
                      </div>
                      <div class="text-right">
                        <div
                          class={`font-bold ${
                            transaction.type === "Ingreso"
                              ? "text-green-600"
                              : "text-red-600"
                          }`}
                        >
                          {transaction.type === "Ingreso" ? "+" : "-"}
                          {formatCurrency(transaction.amount)}
                        </div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">
                          {transaction.account_name || "Cuenta eliminada"}
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )
          )
        )
      }
    </div>

    {
      transactions.length > 0 && (
        <div class="mt-8 text-center">
          <button class="text-indigo-600 hover:text-indigo-700 font-medium">
            Cargar m谩s transacciones
          </button>
        </div>
      )
    }
  </div>
</div>
