<!-- ==================== RESET PASSWORD PAGE ==================== -->
<div
    id="reset-password-page"
    class="hidden min-h-screen flex items-center justify-center bg-gradient-to-br from-indigo-500 to-purple-600 p-4"
>
    <div
        class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl w-full max-w-md p-8 fade-in"
    >
        <div class="text-center mb-8">
            <div
                class="w-16 h-16 bg-indigo-600 rounded-2xl flex items-center justify-center mx-auto mb-4"
            >
                <svg
                    class="w-8 h-8 text-white"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"
                    >
                    </path>
                </svg>
            </div>
            <h2 class="text-3xl font-bold text-gray-900 dark:text-white">
                Restablecer contraseña
            </h2>
            <p class="text-gray-600 dark:text-gray-300 mt-2">
                Ingresa tu nueva contraseña
            </p>
        </div>

        <form class="space-y-4" id="reset-password-form">
            <div>
                <label
                    class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
                    >Nueva Contraseña</label
                >
                <input
                    type="password"
                    id="reset-new-password"
                    placeholder="••••••••"
                    required
                    minlength="8"
                    class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-slate-600 dark:bg-slate-800 dark:text-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition"
                />
            </div>

            <div>
                <label
                    class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
                    >Confirmar Contraseña</label
                >
                <input
                    type="password"
                    id="reset-confirm-password"
                    placeholder="••••••••"
                    required
                    minlength="8"
                    class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-slate-600 dark:bg-slate-800 dark:text-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition"
                />
            </div>

            <div id="password-error" class="hidden">
                <div
                    class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl p-4"
                >
                    <p
                        class="text-red-800 dark:text-red-200 text-sm"
                        id="error-message"
                    >
                    </p>
                </div>
            </div>

            <button
                type="submit"
                id="reset-password-btn"
                class="w-full bg-indigo-600 text-white py-3 rounded-xl font-semibold hover:bg-indigo-700 transform hover:scale-105 transition shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
            >
                Restablecer Contraseña
            </button>
        </form>

        <div class="mt-6 text-center">
            <button
                onclick="showPage('login-page')"
                class="text-indigo-600 font-semibold hover:text-indigo-700"
                >← Volver al inicio de sesión</button
            >
        </div>
    </div>
</div>

<script>
    import { authClient } from "../lib/auth-client";

    const resetPasswordForm = document.getElementById("reset-password-form");
    const resetPasswordBtn = document.getElementById(
        "reset-password-btn",
    ) as HTMLButtonElement;
    const passwordError = document.getElementById("password-error");
    const errorMessage = document.getElementById("error-message");

    function showError(message: string) {
        if (errorMessage && passwordError) {
            errorMessage.textContent = message;
            passwordError.classList.remove("hidden");
        }
    }

    function hideError() {
        if (passwordError) {
            passwordError.classList.add("hidden");
        }
    }

    if (resetPasswordForm) {
        resetPasswordForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            hideError();

            const newPassword = (
                document.getElementById(
                    "reset-new-password",
                ) as HTMLInputElement
            ).value;
            const confirmPassword = (
                document.getElementById(
                    "reset-confirm-password",
                ) as HTMLInputElement
            ).value;

            // Validate passwords match
            if (newPassword !== confirmPassword) {
                showError("Las contraseñas no coinciden");
                return;
            }

            // Get token from URL
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get("token");

            if (!token) {
                showError(
                    "Token inválido o expirado. Por favor, solicita un nuevo enlace de restablecimiento.",
                );
                return;
            }

            try {
                resetPasswordBtn.disabled = true;
                resetPasswordBtn.textContent = "Restableciendo...";

                const { data, error } = await authClient.resetPassword({
                    newPassword,
                    token,
                });

                if (error) {
                    showError(
                        error.message ||
                            "Error al restablecer la contraseña. El enlace puede haber expirado.",
                    );
                    resetPasswordBtn.disabled = false;
                    resetPasswordBtn.textContent = "Restablecer Contraseña";
                    return;
                }

                // Success
                (window as any).showToast(
                    "Contraseña restablecida exitosamente",
                    "success",
                );

                // Clean up URL (remove token and query parameters)
                window.history.replaceState(
                    {},
                    document.title,
                    window.location.pathname,
                );

                // Redirect to login after 2 seconds
                setTimeout(() => {
                    (window as any).showPage("login-page");
                }, 2000);
            } catch (err) {
                console.error(err);
                (window as any).showToast(
                    "Ocurrió un error inesperado",
                    "error",
                );
            } finally {
                resetPasswordBtn.disabled = false;
                resetPasswordBtn.textContent = "Restablecer Contraseña";
            }
        });
    }
</script>
