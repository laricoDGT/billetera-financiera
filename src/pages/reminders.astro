---
import Layout from "../layouts/Layout.astro";
import Modal from "../components/Modal.astro";
import Toast from "../components/Toast.astro";
import { auth } from "../lib/auth";

const session = await auth.api.getSession({
    headers: Astro.request.headers,
});

if (!session) {
    return Astro.redirect("/");
}
---

<Layout title="Recordatorios">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white">
                    Recordatorios
                </h1>
                <p class="text-gray-600 dark:text-gray-300 mt-1">
                    Gestiona tus pagos recurrentes y fechas importantes
                </p>
            </div>
            <button
                onclick="openAddReminderModal()"
                class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition flex items-center space-x-2 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5"
            >
                <svg
                    class="w-5 h-5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 4v16m8-8H4"></path>
                </svg>
                <span>Nuevo Recordatorio</span>
            </button>
        </div>

        <!-- Reminders Container -->
        <div id="reminders-container" class="space-y-8">
            <!-- Loading State -->
            <div class="text-center py-12">
                <div
                    class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto"
                >
                </div>
                <p class="mt-4 text-gray-500">Cargando recordatorios...</p>
            </div>
        </div>
    </div>

    <Modal />
    <Toast />

    <!-- Template for Add/Edit Reminder -->
    <template id="reminder-form-template">
        <div class="flex items-center justify-between mb-4">
            <h3
                class="text-xl font-bold text-gray-900 dark:text-white"
                id="modal-title"
            >
                Nuevo Recordatorio
            </h3>
            <button
                onclick="closeModal()"
                class="text-gray-400 hover:text-gray-600"
            >
                <svg
                    class="w-6 h-6"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <form id="reminder-form" class="space-y-4">
            <input type="hidden" name="id" id="reminder-id" />
            <div>
                <label
                    class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
                    >T√≠tulo</label
                >
                <input
                    type="text"
                    name="title"
                    id="reminder-title"
                    required
                    placeholder="Ej: Pago de Internet"
                    class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500"
                />
            </div>
            <div>
                <label
                    class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
                    >Monto</label
                >
                <input
                    type="number"
                    name="amount"
                    id="reminder-amount"
                    step="0.01"
                    placeholder="0.00"
                    class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500"
                />
            </div>
            <div>
                <label
                    class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
                    >Fecha de Vencimiento</label
                >
                <input
                    type="date"
                    name="due_date"
                    id="reminder-date"
                    required
                    class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500"
                />
            </div>
            <div>
                <label
                    class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
                    >Frecuencia</label
                >
                <select
                    name="frequency"
                    id="reminder-frequency"
                    class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500"
                >
                    <option value="once">Una vez</option>
                    <option value="weekly">Semanal</option>
                    <option value="monthly">Mensual</option>
                    <option value="yearly">Anual</option>
                </select>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button
                    type="button"
                    onclick="closeModal()"
                    class="px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-lg transition"
                >
                    Cancelar
                </button>
                <button
                    type="submit"
                    id="save-reminder-btn"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition flex items-center disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    <svg
                        id="save-spinner"
                        class="animate-spin -ml-1 mr-2 h-4 w-4 text-white hidden"
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                    >
                        <circle
                            class="opacity-25"
                            cx="12"
                            cy="12"
                            r="10"
                            stroke="currentColor"
                            stroke-width="4"></circle>
                        <path
                            class="opacity-75"
                            fill="currentColor"
                            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                        ></path>
                    </svg>
                    <span id="save-text">Guardar</span>
                </button>
            </div>
        </form>
    </template>

    <!-- Payment Confirmation Modal Template -->
    <template id="payment-modal-template">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-bold text-gray-900 dark:text-white">
                Confirmar Pago
            </h3>
            <button
                onclick="closeModal()"
                class="text-gray-400 hover:text-gray-600"
            >
                <svg
                    class="w-6 h-6"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <div class="space-y-4">
            <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg">
                <p class="text-sm text-blue-800 dark:text-blue-200 mb-2">
                    Est√°s a punto de marcar como pagado:
                </p>
                <p
                    class="font-semibold text-gray-900 dark:text-white"
                    id="payment-reminder-title"
                >
                </p>
                <p class="text-sm text-gray-600 dark:text-gray-400">
                    Monto: <span id="payment-amount" class="font-medium"></span>
                </p>
                <p class="text-sm text-gray-600 dark:text-gray-400">
                    Vencimiento: <span id="payment-due-date" class="font-medium"
                    ></span>
                </p>
                <p
                    class="text-sm text-gray-600 dark:text-gray-400"
                    id="payment-frequency-info"
                >
                </p>
            </div>
            <div>
                <label
                    class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"
                    >Notas (opcional)</label
                >
                <textarea
                    id="payment-notes"
                    rows="3"
                    placeholder="Agregar notas sobre este pago..."
                    class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500"
                ></textarea>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button
                    type="button"
                    onclick="closeModal()"
                    class="px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-lg transition"
                >
                    Cancelar
                </button>
                <button
                    type="button"
                    id="confirm-payment-btn"
                    onclick="confirmPayment()"
                    class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition flex items-center disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    <svg
                        id="payment-spinner"
                        class="animate-spin -ml-1 mr-2 h-4 w-4 text-white hidden"
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                    >
                        <circle
                            class="opacity-25"
                            cx="12"
                            cy="12"
                            r="10"
                            stroke="currentColor"
                            stroke-width="4"></circle>
                        <path
                            class="opacity-75"
                            fill="currentColor"
                            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                        ></path>
                    </svg>
                    <span id="payment-btn-text">Confirmar Pago</span>
                </button>
            </div>
        </div>
    </template>

    <!-- Payment History Modal Template -->
    <template id="history-modal-template">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-bold text-gray-900 dark:text-white">
                Historial de Pagos
            </h3>
            <button
                onclick="closeModal()"
                class="text-gray-400 hover:text-gray-600"
            >
                <svg
                    class="w-6 h-6"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <div class="mb-4">
            <p
                class="font-semibold text-gray-900 dark:text-white"
                id="history-reminder-title"
            >
            </p>
            <p
                class="text-sm text-gray-500 dark:text-gray-400"
                id="history-reminder-frequency"
            >
            </p>
        </div>
        <div
            id="payment-history-list"
            class="space-y-3 max-h-96 overflow-y-auto"
        >
            <!-- Payment history items will be inserted here -->
        </div>
        <div
            class="mt-4 text-center"
            id="history-loading"
            style="display: none;"
        >
            <svg
                class="animate-spin h-8 w-8 mx-auto text-indigo-600"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
            >
                <circle
                    class="opacity-25"
                    cx="12"
                    cy="12"
                    r="10"
                    stroke="currentColor"
                    stroke-width="4"></circle>
                <path
                    class="opacity-75"
                    fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                ></path>
            </svg>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">
                Cargando historial...
            </p>
        </div>
        <div
            class="mt-4 text-center text-sm text-gray-500 dark:text-gray-400"
            id="no-payments-message"
            style="display: none;"
        >
            No hay pagos registrados a√∫n.
        </div>
    </template>

    <script>
        // Declare global showToast function
        declare global {
            interface Window {
                showToast: (
                    message: string,
                    type?: "success" | "error" | "info" | "warning",
                ) => void;
            }
        }

        let reminders = [];

        async function fetchReminders() {
            try {
                const response = await fetch("/api/reminders");
                if (!response.ok) throw new Error("Failed to fetch reminders");
                reminders = await response.json();
                renderReminders();
            } catch (error) {
                console.error("Error:", error);
                document.getElementById("reminders-container").innerHTML = `
                    <div class="text-center py-12 text-red-500">
                        Error al cargar recordatorios. Por favor recarga la p√°gina.
                    </div>
                `;
                window.showToast("Error al cargar recordatorios", "error");
            }
        }

        function renderReminders() {
            const container = document.getElementById("reminders-container");

            // Sort reminders: Upcoming (unpaid) first, then paid
            const upcoming = reminders
                .filter((r) => !r.is_paid)
                .sort((a, b) => new Date(a.due_date) - new Date(b.due_date));
            const active = reminders.filter((r) => r.is_paid); // Or maybe active recurring ones? Let's stick to Paid vs Unpaid for now as per mockup logic

            // Actually, the mockup had "Upcoming" (red/orange alerts) and "Active" (list of recurring items).
            // Let's interpret:
            // "Upcoming": Items due soon that are NOT paid.
            // "Active": All items that are active (recurring or not paid yet), displayed in a grid.

            // Let's simplify:
            // Section 1: "Pr√≥ximos" -> Items due within 7 days that are NOT paid.
            // Section 2: "Todos" -> All active reminders.

            const now = new Date();
            const nextWeek = new Date();
            nextWeek.setDate(now.getDate() + 7);

            const urgent = reminders.filter(
                (r) =>
                    !r.is_paid &&
                    new Date(r.due_date) <= nextWeek &&
                    new Date(r.due_date) >=
                        new Date(now.setDate(now.getDate() - 1)),
            ); // Include today/yesterday overdue

            let html = "";

            // Urgent Section
            if (urgent.length > 0) {
                html += `
                    <div class="mb-8">
                        <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Pr√≥ximos Vencimientos</h2>
                        <div class="grid md:grid-cols-2 gap-4">
                            ${urgent.map((r) => renderUrgentCard(r)).join("")}
                        </div>
                    </div>
                `;
            }

            // All Reminders Grid
            html += `
                <div>
                    <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Todos los Recordatorios</h2>
                    <div class="grid md:grid-cols-2 gap-4">
                        ${reminders.map((r) => renderStandardCard(r)).join("")}
                    </div>
                    ${
                        reminders.length === 0
                            ? `
                        <div class="text-center py-12 bg-white dark:bg-slate-800 rounded-2xl border border-dashed border-gray-300 dark:border-slate-700">
                            <p class="text-gray-500 dark:text-gray-400">No tienes recordatorios a√∫n.</p>
                            <button onclick="openAddReminderModal()" class="mt-4 text-indigo-600 hover:text-indigo-700 font-medium">Crear el primero</button>
                        </div>
                    `
                            : ""
                    }
                </div>
            `;

            container.innerHTML = html;
        }

        function renderUrgentCard(reminder) {
            const dueDate = new Date(reminder.due_date);
            const daysUntil = Math.ceil(
                (dueDate - new Date()) / (1000 * 60 * 60 * 24),
            );
            const isOverdue = daysUntil < 0;
            const isToday = daysUntil === 0;

            const colorClass = isOverdue || isToday ? "red" : "orange";

            return `
                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm p-4 border-l-4 border-${colorClass}-500">
                    <div class="flex items-start justify-between">
                        <div class="flex items-start space-x-3">
                            <div class="w-10 h-10 bg-${colorClass}-100 dark:bg-${colorClass}-900/20 rounded-lg flex items-center justify-center mt-1">
                                <span class="text-xl">‚è∞</span>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-semibold text-gray-900 dark:text-white">${reminder.title}</h3>
                                <p class="text-sm text-gray-500 dark:text-gray-400">
                                    ${isOverdue ? `Venci√≥ hace ${Math.abs(daysUntil)} d√≠as` : isToday ? "Vence hoy" : `Vence en ${daysUntil} d√≠as`}
                                </p>
                                <p class="text-sm font-medium text-gray-700 dark:text-gray-300 mt-1">$${parseFloat(reminder.amount).toFixed(2)}</p>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                             <button onclick="editReminder(${reminder.id})" class="p-2 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-lg text-gray-400 hover:text-gray-600">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                            </button>
                        </div>
                    </div>
                    <div class="mt-3 flex gap-2">
                        <button onclick="markAsPaid(${reminder.id})" class="flex-1 bg-${colorClass}-600 text-white py-2 px-4 rounded-lg text-sm font-medium hover:bg-${colorClass}-700 transition">
                            Marcar Pagado
                        </button>
                    </div>
                </div>
            `;
        }

        function renderStandardCard(reminder) {
            const dueDate = new Date(reminder.due_date);
            const daysUntil = Math.ceil(
                (dueDate - new Date()) / (1000 * 60 * 60 * 24),
            );
            const isInactive = !reminder.is_active;

            return `
                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm p-4 border border-gray-200 dark:border-slate-700 ${isInactive ? "opacity-60" : ""}">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center space-x-2">
                            <span class="text-2xl">${getIconForFrequency(reminder.frequency)}</span>
                            <div>
                                <h3 class="font-semibold text-gray-900 dark:text-white ${isInactive ? "line-through" : ""}">${reminder.title}</h3>
                                <p class="text-xs text-gray-500 dark:text-gray-400">${getFrequencyLabel(reminder.frequency)}</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            ${
                                !isInactive
                                    ? `
                                <button onclick="openPaymentModal(${reminder.id})" class="text-gray-400 hover:text-green-500 transition" title="Marcar como pagado">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                </button>
                            `
                                    : ""
                            }
                            <button onclick="viewPaymentHistory(${reminder.id})" class="text-gray-400 hover:text-blue-500 transition" title="Ver historial">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            </button>
                            <button onclick="editReminder(${reminder.id})" class="text-gray-400 hover:text-indigo-500 transition" title="Editar">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                            </button>
                             <button onclick="deleteReminder(${reminder.id})" class="text-gray-400 hover:text-red-500 transition" title="Eliminar">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    </div>
                    <div class="flex justify-between items-center text-sm">
                        <span class="text-gray-600 dark:text-gray-400">$${parseFloat(reminder.amount).toFixed(2)}</span>
                        <span class="${isInactive ? "text-gray-400" : daysUntil < 0 ? "text-red-600" : "text-indigo-600"} font-medium">
                            ${isInactive ? "Completado" : daysUntil < 0 ? `Venci√≥ hace ${Math.abs(daysUntil)} d√≠as` : `En ${daysUntil} d√≠as`}
                        </span>
                    </div>
                </div>
            `;
        }

        function getIconForFrequency(freq) {
            switch (freq) {
                case "weekly":
                    return "üìÖ";
                case "monthly":
                    return "üóìÔ∏è";
                case "yearly":
                    return "üéÇ";
                default:
                    return "üìå";
            }
        }

        function getFrequencyLabel(freq) {
            switch (freq) {
                case "weekly":
                    return "Semanal";
                case "monthly":
                    return "Mensual";
                case "yearly":
                    return "Anual";
                default:
                    return "Una vez";
            }
        }

        // --- Modal & Form Logic ---

        window.openAddReminderModal = function () {
            const template = document.getElementById("reminder-form-template");
            const content = document.getElementById("modal-content");
            const overlay = document.getElementById("modal-overlay");

            content.innerHTML = template.innerHTML;

            // Setup Form Submit
            const form = document.getElementById("reminder-form");
            form.onsubmit = handleFormSubmit;

            overlay.classList.remove("hidden");
        };

        window.editReminder = function (id) {
            const reminder = reminders.find((r) => r.id === id);
            if (!reminder) return;

            openAddReminderModal();

            document.getElementById("modal-title").textContent =
                "Editar Recordatorio";
            document.getElementById("reminder-id").value = reminder.id;
            document.getElementById("reminder-title").value = reminder.title;
            document.getElementById("reminder-amount").value = reminder.amount;
            document.getElementById("reminder-date").value =
                reminder.due_date.split("T")[0];
            document.getElementById("reminder-frequency").value =
                reminder.frequency;
        };

        window.closeModal = function () {
            const overlay = document.getElementById("modal-overlay");
            overlay.classList.add("hidden");
        };

        async function handleFormSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());

            const isEdit = !!data.id;
            const url = "/api/reminders";
            const method = isEdit ? "PUT" : "POST";

            const btn = document.getElementById("save-reminder-btn");
            const spinner = document.getElementById("save-spinner");
            const text = document.getElementById("save-text");

            if (!btn || !spinner || !text) return;

            // Loading state
            // @ts-ignore
            btn.disabled = true;
            spinner.classList.remove("hidden");
            text.textContent = "Guardando...";

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data),
                });

                if (!response.ok) throw new Error("Failed to save reminder");

                closeModal();
                fetchReminders();
                window.showToast(
                    "Recordatorio guardado exitosamente",
                    "success",
                );
            } catch (error) {
                console.error("Error:", error);
                window.showToast("Error al guardar el recordatorio", "error");
            } finally {
                // Reset state
                if (btn) {
                    // @ts-ignore
                    btn.disabled = false;
                    spinner.classList.add("hidden");
                    text.textContent = "Guardar";
                }
            }
        }

        // --- Actions ---

        window.markAsPaid = async function (id) {
            await togglePaid(id, true);
        };

        window.togglePaid = async function (id, isPaid) {
            try {
                const response = await fetch("/api/reminders", {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ id, is_paid: isPaid }),
                });

                if (!response.ok) throw new Error("Failed to update status");
                fetchReminders();
                window.showToast(
                    isPaid
                        ? "Recordatorio marcado como pagado"
                        : "Recordatorio marcado como pendiente",
                    "success",
                );
            } catch (error) {
                console.error("Error:", error);
                window.showToast("Error al actualizar el estado", "error");
            }
        };

        window.deleteReminder = async function (id) {
            if (!confirm("¬øEst√°s seguro de eliminar este recordatorio?"))
                return;

            try {
                const response = await fetch(`/api/reminders?id=${id}`, {
                    method: "DELETE",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ id }), // Fallback
                });

                if (!response.ok) throw new Error("Failed to delete");
                fetchReminders();
                window.showToast("Recordatorio eliminado", "success");
            } catch (error) {
                console.error("Error:", error);
                window.showToast("Error al eliminar", "error");
            }
        };

        // --- Payment Modal Logic ---
        let currentPaymentReminderId = null;

        window.openPaymentModal = async function (id) {
            currentPaymentReminderId = id;
            const reminder = reminders.find((r) => r.id === id);
            if (!reminder) return;

            const template = document.getElementById("payment-modal-template");
            const content = document.getElementById("modal-content");
            const overlay = document.getElementById("modal-overlay");

            if (!template || !content || !overlay) return;

            content.innerHTML = template.innerHTML;

            // Populate payment details
            const titleEl = document.getElementById("payment-reminder-title");
            const amountEl = document.getElementById("payment-amount");
            const dueDateEl = document.getElementById("payment-due-date");
            const frequencyInfoEl = document.getElementById(
                "payment-frequency-info",
            );

            if (titleEl) titleEl.textContent = reminder.title;
            if (amountEl)
                amountEl.textContent = `$${parseFloat(reminder.amount).toFixed(2)}`;
            if (dueDateEl)
                dueDateEl.textContent = new Date(
                    reminder.due_date,
                ).toLocaleDateString("es-ES");

            if (frequencyInfoEl) {
                if (reminder.frequency === "once") {
                    frequencyInfoEl.textContent =
                        "Este recordatorio se marcar√° como completado.";
                } else {
                    const nextDate = calculateNextDueDateClient(
                        new Date(reminder.due_date),
                        reminder.frequency,
                    );
                    frequencyInfoEl.textContent = `Pr√≥ximo vencimiento: ${nextDate.toLocaleDateString("es-ES")} (${getFrequencyLabel(reminder.frequency)})`;
                }
            }

            overlay.classList.remove("hidden");
        };

        window.confirmPayment = async function () {
            if (!currentPaymentReminderId) return;

            const notesEl = document.getElementById("payment-notes");
            const notes = notesEl ? notesEl.value : "";

            const btn = document.getElementById("confirm-payment-btn");
            const spinner = document.getElementById("payment-spinner");
            const btnText = document.getElementById("payment-btn-text");

            // Show loading state
            if (btn) {
                // @ts-ignore
                btn.disabled = true;
            }
            if (spinner) spinner.classList.remove("hidden");
            if (btnText) btnText.textContent = "Procesando...";

            try {
                const response = await fetch("/api/reminders", {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        id: currentPaymentReminderId,
                        is_paid: true,
                        payment_notes: notes,
                    }),
                });

                if (!response.ok) throw new Error("Failed to mark as paid");

                closeModal();
                fetchReminders();
                window.showToast("Pago registrado exitosamente", "success");
                currentPaymentReminderId = null;
            } catch (error) {
                console.error("Error:", error);
                window.showToast("Error al registrar el pago", "error");
            } finally {
                // Reset loading state
                if (btn) {
                    // @ts-ignore
                    btn.disabled = false;
                }
                if (spinner) spinner.classList.add("hidden");
                if (btnText) btnText.textContent = "Confirmar Pago";
            }
        };

        // --- Payment History Modal Logic ---
        window.viewPaymentHistory = async function (id) {
            const reminder = reminders.find((r) => r.id === id);
            if (!reminder) return;

            const template = document.getElementById("history-modal-template");
            const content = document.getElementById("modal-content");
            const overlay = document.getElementById("modal-overlay");

            if (!template || !content || !overlay) return;

            content.innerHTML = template.innerHTML;

            // Set reminder info
            const titleEl = document.getElementById("history-reminder-title");
            const frequencyEl = document.getElementById(
                "history-reminder-frequency",
            );

            if (titleEl) titleEl.textContent = reminder.title;
            if (frequencyEl)
                frequencyEl.textContent = getFrequencyLabel(reminder.frequency);

            // Show loading state
            const loadingEl = document.getElementById("history-loading");
            const listEl = document.getElementById("payment-history-list");
            const noPaymentsEl = document.getElementById("no-payments-message");

            if (loadingEl) loadingEl.style.display = "block";
            if (listEl) listEl.innerHTML = "";
            if (noPaymentsEl) noPaymentsEl.style.display = "none";

            overlay.classList.remove("hidden");

            // Fetch payment history
            try {
                const response = await fetch(`/api/reminders/${id}/payments`);
                if (!response.ok) throw new Error("Failed to fetch history");

                const payments = await response.json();

                // Hide loading
                if (loadingEl) loadingEl.style.display = "none";

                if (payments.length === 0) {
                    if (noPaymentsEl) noPaymentsEl.style.display = "block";
                } else {
                    if (listEl) {
                        listEl.innerHTML = payments
                            .map(
                                (payment) => `
                            <div class="bg-gray-50 dark:bg-slate-700 p-4 rounded-lg">
                                <div class="flex justify-between items-start mb-2">
                                    <div>
                                        <p class="font-medium text-gray-900 dark:text-white">$${parseFloat(payment.amount).toFixed(2)}</p>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">Vencimiento: ${new Date(payment.due_date).toLocaleDateString("es-ES")}</p>
                                    </div>
                                    <span class="text-xs text-green-600 dark:text-green-400 font-medium">Pagado</span>
                                </div>
                                <p class="text-xs text-gray-500 dark:text-gray-400">Fecha de pago: ${new Date(payment.paid_date).toLocaleDateString("es-ES")}</p>
                                ${payment.notes ? `<p class="text-sm text-gray-600 dark:text-gray-300 mt-2">${payment.notes}</p>` : ""}
                            </div>
                        `,
                            )
                            .join("");
                    }
                }
            } catch (error) {
                console.error("Error:", error);
                if (loadingEl) loadingEl.style.display = "none";
                window.showToast("Error al cargar el historial", "error");
                closeModal();
            }
        };

        // Helper function to calculate next due date on client side
        function calculateNextDueDateClient(currentDueDate, frequency) {
            const next = new Date(currentDueDate);

            switch (frequency) {
                case "weekly":
                    next.setDate(next.getDate() + 7);
                    break;
                case "monthly":
                    next.setMonth(next.getMonth() + 1);
                    break;
                case "yearly":
                    next.setFullYear(next.getFullYear() + 1);
                    break;
            }

            return next;
        }

        // Initialize
        fetchReminders();
    </script>
</Layout>
